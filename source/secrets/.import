#!/usr/bin/env bash

# Import Environmen variables stored in a 1Password account
# By default, it will use the `my.1password.com` account
# If you want to use a different account,
#   simply provide the account name as the first argument
#
# Examples:
# - `$ importEnv`
# - `$ importEnv foo`
#
# Inspired by https://grantorchard.com/securing-environment-variables-with-1password/

function importEnv() {
	local opaccount=${1:-my}

	# Login to 1Password.
	# Assumes you have installed the OP CLI and performed the initial configuration
	# For more details see https://support.1password.com/command-line-getting-started/
	eval $(op signin $opaccount)

	# An 1password entry with name Environment Variables needs to be set
	#  and all variables must be set in a single section. Label will be used
	#  as the export key and value as its value.
	local res=`op get item "Environment Variables"`

	# Convert to base64 for multi-line secrets.
	# The schema for the 1Password type 'Password' uses
	#   t as the label, and v as the value.
	for row in $(echo ${res} | jq -r -c '.details.sections | sort | .[0].fields[] | @base64'); do
		_evalJq() {
			echo ${row} | base64 --decode | jq -r $1
		}
		local name=`_evalJq .t`
		local value=`_evalJq .v`

		echo "* Setting environment variable ${name}"
		export $(echo "${name}=${value}")
	done
}
